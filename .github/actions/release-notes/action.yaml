name: Prepare release notes
description: Prepare release notes for the upcoming release

inputs:
  from-version:
    description: The version of the release to archive.
    required: true
  to-version:
    description: The version to use to create release notes.
    required: true

# git reset --hard origin/${{ steps.latest.outputs.branch }}
runs:
  using: composite
  steps:
    - name: Archive previous release
      shell: bash
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        set -ex
        version_x=$(echo ${{ inputs.from-version }} | sed 's/.$/x/')
        sed -i "/ARCHIVE_START/a * [$version_x](https://github.com/${{ github.repository }}/blob/release-${{ inputs.from-version }}/RELEASES.md)" RELEASES.md

    - name: Create next release notes
      shell: bash
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        set -ex
        sed -i '0,/---/d' RELEASES.md
        archive=$(cat RELEASES.md)

        cat > RELEASES.md <<EOF
        ## ${{ inputs.to-version }}

        Unreleased

        ### Added

        ### Changed

        ---
        $archive
        EOF

        git commit -am "Update release notes for ${{ inputs.to-version }}"
        git push origin HEAD:ci/next-${{ inputs.to-version }}
